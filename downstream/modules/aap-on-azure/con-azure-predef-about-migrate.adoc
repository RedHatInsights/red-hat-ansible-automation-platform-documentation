////
Base the file name and the ID on the module title. For example:
* file name: con-my-concept-module-a.adoc
* ID: [id="con-my-concept-module-a_{context}"]
* Title: = My concept module A
////

[id="con-azure-predef-about-migrate"]

= About the migrating resources between regions template

// [role="_abstract"]

The `migrating resources between regions` template executes the link:https://github.com/ansible-collections/cloud.azure_roles/blob/main/playbooks/webapp.yml[`vmss_migrate.yml`] playbook from the `cloud.azure_roles` GitHub repository.

The playbook moves a deployed application from one resource group to another, typically between regions.

For multi-regional applications, it is useful to be able to migrate the application deployment to an Azure region closer to the application's users.

// .Prerequisites
// 
//Describe the information needed before launching the template

== Execution sequence

The list below shows the sequence in which the resources are generated in the destination region and deleted in the source region. Links are provided to the roles, tasks and modules that complete the job.

* The link:https://github.com/ansible-collections/cloud.azure_roles/blob/main/playbooks/vmss_migrate.yml[`vmss_migrate.yml`] playbook invokes the link:https://github.com/ansible-collections/cloud.azure_roles/tree/main/playbooks/roles/scale_virtual_machine[`scale_virtual_machine`] role, specifying the `create` operation, to create the application infrastructure in another Azure resource group. Variables representing the destination region and the source resource group properties are passed to the role.
** This role executes the link:https://github.com/ansible-collections/cloud.azure_roles/blob/main/playbooks/roles/scale_virtual_machine/tasks/create.yml[`create.yml`] task, which implements the following:
** Creates a resource group in the destination Azure region using the link:https://github.com/ansible-collections/cloud.azure_roles/tree/main/roles/resource_group[`resource_group`] role:
** Creates a network security group by invoking the `azure.azcollection` link:https://docs.ansible.com/ansible/latest/collections/azure/azcollection/azure_rm_securitygroup_module.html#ansible-collections-azure-azcollection-azure-rm-securitygroup-module[`azure_rm_securitygroup`] module.
** Creates an Azure networking stack using the link:https://github.com/ansible-collections/cloud.azure_roles/tree/main/roles/networking_stack[`networking_stack`] role in `cloud.azure_roles`.
** Deploys a load balancer with a public IP address by invoking the `azure.azcollection` link:https://docs.ansible.com/ansible/latest/collections/azure/azcollection/azure_rm_loadbalancer_module.html#ansible-collections-azure-azcollection-azure-rm-loadbalancer-module[`azure_rm_loadbalancer`] module.
** Creates a bastion host with a public IP address, and adds it to the inventory. The link:https://github.com/ansible-collections/cloud.azure_roles/blob/main/playbooks/roles/scale_virtual_machine/tasks/create_bastion.yml[`create_bastion.yml`] task invokes the link:https://docs.ansible.com/ansible/latest/collections/azure/azcollection/azure_rm_publicipaddress_module.html#ansible-collections-azure-azcollection-azure-rm-publicipaddress-module[`azure_rm_publicipaddress`], link:https://docs.ansible.com/ansible/latest/collections/azure/azcollection/azure_rm_virtualmachine_module.html#ansible-collections-azure-azcollection-azure-rm-virtualmachine-module[`azure_rm_virtualmachine`], and link:https://docs.ansible.com/ansible/latest/collections/azure/azcollection/azure_rm_networkinterface_module.html#ansible-collections-azure-azcollection-azure-rm-networkinterface-module[`azure_rm_networkinterface`] modules from `azure.azcollection`.
** Creates a virtual machine scale set by invoking the `invoking the `azure.azcollection` link:http://azure_rm_virtualmachinescaleset[`azure_rm_virtualmachinescaleset`] module.
** Adds the bastion host to the inventory by invoking the link:https://docs.ansible.com/ansible/latest/collections/ansible/builtin/add_host_module.html#ansible-collections-ansible-builtin-add-host-module[`ansible.builtin.add_host`] module.
* Installs Python3 and Ansible on the bastion host in the destination region.
* Copies the link:https://github.com/ansible-collections/cloud.azure_roles/blob/main/playbooks/files/deploy-app.yml[`deploy_app.yml`] playbook to [filename]`play.yml` on the bastion host.
* Deploys the app from the bastion host by executing a shell command on the bastion host to run the [filename]`play.yml` playbook.
* Invokes the link:https://github.com/ansible-collections/cloud.azure_roles/tree/main/playbooks/roles/scale_virtual_machine[`scale_virtual_machine`] role, specifying the `delete` operation, to delete the resource group for the application from the source Azure region.
* Deletes the bastion host from the source region by setting the azure_rm_virtualmachine module to the absent state.
* Deletes the virtual machine scale set from the source region by setting the azure_rm_virtualmachinescaleset module to the absent state.
* Deletes the virtual network set from the source region by setting the azure_rm_virtualnetwork module to the absent state.
* Deletes the subnet from the source region by setting the azure_rm_subnet module to the absent state.
* Deletes the load balancer from the source region by setting the azure_rm_loadbalancer module to the absent state.
* Deletes the public IP address for the load balancer in the source region by setting the azure_rm_publicipaddress module to the absent state.
* Deletes the networking security group from the source region by setting the azure_rm_securitygroup module to the absent state.
* Prints a message displaying the URL for the application in the destination region.





